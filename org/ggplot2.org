#+TITLE:  DataCamp Review: introduction to data visualization with ggplot2
#+AUTHOR: Marcus Birkenkrahe (pledged)
#+Subtitle: Introduction to Data Visualization
#+STARTUP: hideblocks overview indent inlineimages
#+PROPERTY: header-args:R :exports both :results output :session *R*
* README

- Review of the 1st chapter of the DataCamp course
- Add your name and ~(pledged)~ in the ~#+AUTHOR:~ meta headline
- When you've completed the file, submit it in Canvas

* Identify yourself

1) Add your name and ~(pledged)~ at the top
2) Run the ~#+PROPERTY~ and ~#+STARTUP~ lines with ~C-c C-c~
3) You should open the R session in the same directory as this file
4) To check, run ~getwd()~ in the R console window

Check that we have an R console:
#+begin_src R
  "hello good afternoon"
#+end_src   

#+RESULTS:
: [1] "hello good afternoon"
   
* DONE Answer conceptual questions about =ggplot2= and base R

- What is the requirement for the DataCamp course "[[https://app.datacamp.com/learn/courses/introduction-to-data-visualization-with-ggplot2][Introduction to
  Data Visualization with ggplot2]]", and where can you find this
  information?
  #+begin_quote
  The prerequisite for this course is "Introduction to the Tidyverse"
  #+end_quote
  
- What is the "[[https://www.tidyverse.org/][Tidyverse]]"?
  #+begin_quote
   "This is an introduction to the programming language R, focused on
   a powerful set of tools known as the Tidyverse..." more at
   tidyverse.org.
  #+end_quote

- What are the layers of the 'Grammar of Graphics'?
  #+begin_quote
  It's a graphics framework used to design =ggplot2=. Its layers:
  1) Data (dataset)
  2) Aesthetics (which data do you want to plot?)
  3) Geometries (what type of plot do I want?)
  4) Facets (how many panels of plots do you want?)
  5) Statistics (what do the data have to tell us?)
  6) Coordinates (do I want transform the data?)
  7) Theme (what look do I want for my plot?)
  #+end_quote

- What are some examples for these elements in ~ggplot2~?
  #+begin_quote
  - =aes()=
  - =geom_point=
  - =theme_minimal=
  - ..
  #+end_quote

- Can you save a ~ggplot2~ plot as an R object?
  #+begin_src R :file gg.png :session *R* :results file graphics 
    ## Save a ggplot histogram of `Nile` to an R object `g` and print it
    library(ggplot2)
    ggplot(
      data = data.frame(Nile),
      aes(Nile)) +
      geom_histogram() -> gg
    gg
  #+end_src

  #+RESULTS:
  [[file:gg.png]]

- Look at the structure of this =ggplot2= object:
  #+begin_src R
    attributes(gg)
    str(gg)
  #+end_src  

  #+RESULTS:
  #+begin_example
  $names
  [1] "data"        "layers"      "scales"      "mapping"     "theme"       "coordinates" "facet"      
  [8] "plot_env"    "labels"     

  $class
  [1] "gg"     "ggplot"
  List of 9
   $ data       :'data.frame':	100 obs. of  1 variable:
    ..$ Nile: Time-Series [1:100] from 1871 to 1970: 1120 1160 963 1210 1160 1160 813 1230 1370 1140 ...
   $ layers     :List of 1
    ..$ :Classes 'LayerInstance', 'Layer', 'ggproto', 'gg' <ggproto object: Class LayerInstance, Layer, gg>
      aes_params: list
      compute_aesthetics: function
      compute_geom_1: function
      compute_geom_2: function
      compute_position: function
      compute_statistic: function
      computed_geom_params: list
      computed_mapping: uneval
      computed_stat_params: list
      constructor: call
      data: waiver
      draw_geom: function
      finish_statistics: function
      geom: <ggproto object: Class GeomBar, GeomRect, Geom, gg>
          aesthetics: function
          default_aes: uneval
          draw_group: function
          draw_key: function
          draw_layer: function
          draw_panel: function
          extra_params: just na.rm orientation
          handle_na: function
          non_missing_aes: xmin xmax ymin ymax
          optional_aes: 
          parameters: function
          rename_size: TRUE
          required_aes: x y
          setup_data: function
          setup_params: function
          use_defaults: function
          super:  <ggproto object: Class GeomRect, Geom, gg>
      geom_params: list
      inherit.aes: TRUE
      layer_data: function
      map_statistic: function
      mapping: NULL
      position: <ggproto object: Class PositionStack, Position, gg>
          compute_layer: function
          compute_panel: function
          fill: FALSE
          required_aes: 
          reverse: FALSE
          setup_data: function
          setup_params: function
          type: NULL
          vjust: 1
          super:  <ggproto object: Class Position, gg>
      print: function
      setup_layer: function
      show.legend: NA
      stat: <ggproto object: Class StatBin, Stat, gg>
          aesthetics: function
          compute_group: function
          compute_layer: function
          compute_panel: function
          default_aes: uneval
          dropped_aes: weight
          extra_params: na.rm orientation
          finish_layer: function
          non_missing_aes: 
          optional_aes: 
          parameters: function
          required_aes: x|y
          retransform: TRUE
          setup_data: function
          setup_params: function
          super:  <ggproto object: Class Stat, gg>
      stat_params: list
      super:  <ggproto object: Class Layer, gg> 
   $ scales     :Classes 'ScalesList', 'ggproto', 'gg' <ggproto object: Class ScalesList, gg>
      add: function
      clone: function
      find: function
      get_scales: function
      has_scale: function
      input: function
      n: function
      non_position_scales: function
      scales: list
      super:  <ggproto object: Class ScalesList, gg> 
   $ mapping    :List of 1
    ..$ x: language ~Nile
    .. ..- attr(*, ".Environment")=<environment: R_GlobalEnv> 
    ..- attr(*, "class")= chr "uneval"
   $ theme      : list()
   $ coordinates:Classes 'CoordCartesian', 'Coord', 'ggproto', 'gg' <ggproto object: Class CoordCartesian, Coord, gg>
      aspect: function
      backtransform_range: function
      clip: on
      default: TRUE
      distance: function
      expand: TRUE
      is_free: function
      is_linear: function
      labels: function
      limits: list
      modify_scales: function
      range: function
      render_axis_h: function
      render_axis_v: function
      render_bg: function
      render_fg: function
      setup_data: function
      setup_layout: function
      setup_panel_guides: function
      setup_panel_params: function
      setup_params: function
      train_panel_guides: function
      transform: function
      super:  <ggproto object: Class CoordCartesian, Coord, gg> 
   $ facet      :Classes 'FacetNull', 'Facet', 'ggproto', 'gg' <ggproto object: Class FacetNull, Facet, gg>
      compute_layout: function
      draw_back: function
      draw_front: function
      draw_labels: function
      draw_panels: function
      finish_data: function
      init_scales: function
      map_data: function
      params: list
      setup_data: function
      setup_params: function
      shrink: TRUE
      train_scales: function
      vars: function
      super:  <ggproto object: Class FacetNull, Facet, gg> 
   $ plot_env   :<environment: R_GlobalEnv> 
   $ labels     :List of 3
    ..$ x     : chr "Nile"
    ..$ y     : chr "count"
    .. ..- attr(*, "fallback")= logi TRUE
    ..$ weight: chr "weight"
    .. ..- attr(*, "fallback")= logi TRUE
   - attr(*, "class")= chr [1:2] "gg" "ggplot"
  #+end_example
  
- Can you save a ~base R~ plot as an R object?
  #+begin_src R :file hist.png :session *R* :results file graphics 
    ## Save a base R histogram of `Nile` to an R object `h` and print it
    hist(Nile) -> h
    h
  #+end_src

  #+RESULTS:
  [[file:hist.png]]

  #+begin_src R :file hist.png :session *R* :results file graphics 
    ## Save a base R line plot of `Nile` to an R object `p` and print it
    plot(Nile) -> p
    p
  #+end_src

  #+RESULTS:
  [[file:hist.png]]

  #+begin_src R
    ## Print the `attributes` and the `str`[ucture] of the histogram `h`
    str(h)
    attributes(h)
  #+end_src

  #+RESULTS:
  #+begin_example
  List of 6
   $ breaks  : int [1:11] 400 500 600 700 800 900 1000 1100 1200 1300 ...
   $ counts  : int [1:10] 1 0 5 20 25 19 12 11 6 1
   $ density : num [1:10] 0.0001 0 0.0005 0.002 0.0025 0.0019 0.0012 0.0011 0.0006 0.0001
   $ mids    : num [1:10] 450 550 650 750 850 950 1050 1150 1250 1350
   $ xname   : chr "Nile"
   $ equidist: logi TRUE
   - attr(*, "class")= chr "histogram"
  $names
  [1] "breaks"   "counts"   "density"  "mids"     "xname"    "equidist"

  $class
  [1] "histogram"
  #+end_example

- Can you combine ~ggplot2~ and ~base R~ graphics in one plot array?
  #+begin_quote
  Answer: No. Base R and ggplot2 graphics are complete different.
  In base R, plots are created by opening and closing graphics devices.
  In ggplot2, plots are layered R objects.
  #+end_quote

- Graphics devices:
  #+begin_src R
    dev.off()
  #+end_src

  #+RESULTS:
  : Error in dev.off() : cannot shut down device 1 (the null device)

* DONE Create simple scatterplots with =ggplot2= and base R

We're going to work with ~MASS::mammals~ using ~ggplot2~ and ~base R~.

1) Load the relevant packages.

   #+begin_src R :results output
     library(MASS)
     library(ggplot2)
     search()
   #+end_src

   #+RESULTS:
   :  [1] ".GlobalEnv"        "package:MASS"      "package:ggplot2"   "ESSR"              "package:stats"    
   :  [6] "package:graphics"  "package:grDevices" "package:utils"     "package:datasets"  "package:methods"  
   : [11] "Autoloads"         "package:base"

2) Show the data structure of ~mammals~.

   #+begin_src R
     str(mammals)
   #+end_src

   #+RESULTS:
   : 'data.frame':	62 obs. of  2 variables:
   :  $ body : num  3.38 0.48 1.35 465 36.33 ...
   :  $ brain: num  44.5 15.5 8.1 423 119.5 ...

3) Create a scatterplot of ~brain~ vs ~body~ of the ~mammals~ data set in
   ~ggplot2~.

   #+begin_src R :results graphics file :file mammals_gg.png
     ggplot(data=mammals, aes(x=body,y=brain)) +
       geom_point()
   #+end_src

   #+RESULTS:
   [[file:mammals_gg.png]]

4) Create a scatterplot of ~brain~ vs ~body~ of the ~mammals~ data set in
   ~base R~.

   #+begin_src R :results graphics file :file mammals.png
     plot(mammals,las=1)
   #+end_src

   #+RESULTS:
   [[file:mammals.png]]

* TODO Transform plots

1) What's the problem with these plots and what could you do about it?

   #+begin_quote
   *The problem:* The data points are too bunched up because there are some
   extreme outliers (brain/body ratio of some animals is very large).

   *The solution:* Transform both axes logarithmically!
   #+end_quote

2) Implement the solution with ~plot~.
   #+begin_src R :results graphics file :file mammals1.png
     plot(log10(mammals))  # x -> log(x,base = 10)
   #+end_src

   #+RESULTS:
   [[file:mammals1.png]]

3) Implement the solution with ~ggplot~ - save the plot as ~gg~ for later,
   and print it.
   #+begin_src R :results graphics file :file mammals1_gg.png
     ggplot(
       data=mammals,
       aes(x=body,y=brain)) +
       geom_point(alpha=0.6) +   # alpha specifies point transparency
       coord_fixed() +    
       scale_x_log10() +
       scale_y_log10() -> gg
   #+end_src

   #+RESULTS:
   [[file:mammals1_gg.png]]

4) What does the ~geom_point~ argument ~alpha~ do?

   #+begin_quote
   Answer: alpha reduces the transparency by 40% (factor 0.6)
   #+end_quote
   
* TODO Create trendlines

1) Create a linear trendline for the ~ggplot2~ plot ~gg~. Inside the
   smoothing geometry, use ~method="lm"~ to fix the model.

   #+begin_src R :results graphics file :file mammalslog_gg_lm.png
     gg +
       geom_smooth(method="lm") # create a linear regression trendline
   #+end_src

   #+RESULTS:
   [[file:mammalslog_gg_lm.png]]

2) Create a linear model in ~base R~ using ~lm~ and
   ~data-log10(mammals)~. Save it as ~line~ and print it.

   #+begin_src R
     lm(brain ~ body, data=log10(mammals)) -> line
     line
   #+end_src

   #+RESULTS:
   : 
   : Call:
   : lm(formula = brain ~ body, data = log10(mammals))
   : 
   : Coefficients:
   : (Intercept)         body  
   :      0.9271       0.7517

3) Create a trendline plot in ~base R~ using the linear model. The line
   should be red, dashed and double wide.

   #+begin_src R :results graphics file :file mammals_lm.png
     plot(log10(mammals))
     abline(line, col="red", lty=2, lwd=2)
   #+end_src

   #+RESULTS:
   [[file:mammals_lm.png]]

* TODO Map 'aesthetics' to variables

Recall that the ~mtcars~ data frame lists the characteristics mileage
(~mpg~), weight (~wt~) and number of cylinders (~cyl~) as ~numeric~ variables.

1) Create a ~ggplot~ of mileage vs. weight using ~ggplot2~, save it as ~gg~
   and print it.

   #+begin_src R :results graphics file :file mtcars_gg_aes.png
     ggplot(data=mtcars, aes(wt,mpg)) -> gg
   #+end_src

   #+RESULTS:
   [[file:mtcars_gg_aes.png]]

2) Create a scatterplot where the color 'aesthetic' is mapped to the
   number of cylinders by adding a 'geometry' to ~gg~.

   #+begin_src R :results graphics file :file mtcars_gg_col.png
     gg +
       geom_point(aes(color=factor(cyl))) 
   #+end_src

   #+RESULTS:
   [[file:mtcars_gg_col.png]]

3) What's the difference between mapping 'aesthetics' inside the
   'geometry' or inside the ~ggplot~ function?

   #+begin_quote
   Answer: The =aes= function knows about the dataset from =data=. You can
   also layer additional dimensions on top of the original plot using
   =aes= inside the =geom_= function.
   #+end_quote
   
